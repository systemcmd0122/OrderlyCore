// systemcmd0122/overseer/overseer-cf1a61a3cde5488b9069c3d045c3c65a4f6f98bc/public/client.js
document.addEventListener('DOMContentLoaded', async () => {
    // DOM elements
    const loader = document.getElementById('loader');
    const dashboardWrapper = document.querySelector('.dashboard-wrapper');
    const pageContent = document.getElementById('page-content');
    const pageTitle = document.getElementById('page-title');
    const navItems = document.querySelectorAll('.nav-item');
    const logoutBtn = document.getElementById('logout-btn');
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.querySelector('.sidebar');

    let guildInfo = null;
    let settingsCache = {};
    let isDirty = false;
    let currentChart = null; // To hold the Chart.js instance

    // --- Utility Functions ---

    // Unified API request handler
    const api = {
        _request: async (endpoint, options = {}) => {
            try {
                const res = await fetch(endpoint, options);
                if (res.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || `Request failed with status ${res.status}`);
                return data;
            } catch (err) {
                console.error(`API request error on ${endpoint}:`, err);
                showMessage(`Error: ${err.message}`, 'error');
                throw err;
            }
        },
        get: (endpoint) => api._request(endpoint),
        post: (endpoint, body) => api._request(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        }),
        put: (endpoint, body) => api._request(endpoint, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        }),
        delete: (endpoint) => api._request(endpoint, { method: 'DELETE' })
    };

    // Toast notification function
    const showMessage = (text, type = 'success') => {
        const el = document.createElement('div');
        el.className = `message-toast ${type}`;
        el.textContent = text;
        document.body.appendChild(el);
        setTimeout(() => el.classList.add('show'), 10);
        setTimeout(() => {
            el.classList.remove('show');
            setTimeout(() => el.remove(), 300);
        }, 3000);
    };

    // Modal creation function
    const createModal = (title, content, footerButtons) => {
        closeModal();
        document.querySelector('#modal-container').innerHTML = `
            <div class="modal-backdrop">
                <div class="modal">
                    <div class="modal-header">
                        <h2>${title}</h2>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body">${content}</div>
                    <div class="modal-footer">
                        ${footerButtons.map(btn => `<button id="${btn.id}" class="btn ${btn.class || ''}">${btn.text}</button>`).join('')}
                    </div>
                </div>
            </div>`;
        const backdrop = document.querySelector('.modal-backdrop');
        backdrop.querySelector('.close-btn').onclick = closeModal;
        backdrop.onclick = (e) => {
            if (e.target === backdrop) closeModal();
        };
        setTimeout(() => backdrop.classList.add('show'), 10);
        return backdrop.querySelector('.modal');
    };

    // Modal close function
    const closeModal = () => {
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.classList.remove('show');
            setTimeout(() => backdrop.remove(), 300);
        }
    };

    // Tom Select initialization
    const initializeTomSelect = (selector, options = {}) => {
        const elements = typeof selector === 'string' ? document.querySelectorAll(selector) : [selector];
        elements.forEach(el => {
            if (el && el.tomselect) {
                el.tomselect.destroy();
            }
            if (el) {
                new TomSelect(el, {
                    create: false,
                    allowEmptyOption: true,
                    placeholder: el.getAttribute('placeholder') || 'Select...',
                    ...options
                });
            }
        });
    };
    
    const trackChanges = (formSelector) => {
        const form = document.querySelector(formSelector);
        if (form) {
            const setDirty = () => {
                isDirty = true;
                console.log('Changes detected, isDirty set to true.');
            };
            form.addEventListener('input', setDirty);
            form.addEventListener('change', setDirty);
        }
    };

    const resetDirtyState = () => {
        isDirty = false;
        console.log('isDirty reset to false.');
    };

    // --- Page Rendering ---
    const renderers = {
        dashboard: async () => {
            pageTitle.textContent = '„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ';
            const settings = await api.get('/api/settings/guilds');
            pageContent.innerHTML = `
                <div class="grid-container" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    <div class="card stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <div class="stat-value">${(guildInfo.memberCount || 0).toLocaleString()}</div>
                            <div class="stat-label">„É°„É≥„Éê„ÉºÊï∞</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">ü§ñ</div>
                        <div class="stat-info">
                            <div class="stat-value">${(guildInfo.botCount || 0).toLocaleString()}</div>
                            <div class="stat-label">„Éú„ÉÉ„ÉàÊï∞</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-info">
                            <div class="stat-value">${(settings.statistics?.totalJoins || 0).toLocaleString()}</div>
                            <div class="stat-label">Á∑èÂèÇÂä†ËÄÖÊï∞</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">üìâ</div>
                        <div class="stat-info">
                            <div class="stat-value">${(settings.statistics?.totalLeaves || 0).toLocaleString()}</div>
                            <div class="stat-label">Á∑èÈÄÄÂá∫ËÄÖÊï∞</div>
                        </div>
                    </div>
                </div>`;
        },

        // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
        members: async () => {
            pageTitle.textContent = '„É°„É≥„Éê„ÉºÁÆ°ÁêÜ';
            pageContent.innerHTML = `
                <div class="card">
                    <div class="card-header"><h3>„É°„É≥„Éê„Éº‰∏ÄË¶ß</h3></div>
                    <div class="filter-bar">
                        <div class="form-group">
                             <label for="member-search">„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢</label>
                            <input type="text" id="member-search" placeholder="ÂêçÂâç„ÅßÊ§úÁ¥¢...">
                        </div>
                        <div class="form-group">
                             <label for="role-filter">„É≠„Éº„É´„ÅßÁµû„ÇäËæº„Åø</label>
                            <select id="role-filter" placeholder="„É≠„Éº„É´„ÇíÈÅ∏Êäû...">
                                <option value="">„Åô„Åπ„Å¶„ÅÆ„É≠„Éº„É´</option>
                                ${guildInfo.roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th data-sort="displayName">„É¶„Éº„Ç∂„Éº <span class="sort-indicator"></span></th>
                                    <th>„É≠„Éº„É´</th>
                                    <th data-sort="joinedAt">ÂèÇÂä†Êó• <span class="sort-indicator"></span></th>
                                    <th data-sort="messageCount">Áµ±Ë®à <span class="sort-indicator"></span></th>
                                    <th>„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                                </tr>
                            </thead>
                            <tbody id="members-table-body"></tbody>
                        </table>
                    </div>
                    <div class="pagination-controls">
                        <button id="prev-page" class="btn btn-secondary btn-small" disabled>Ââç„Å∏</button>
                        <span id="page-info" class="page-info"></span>
                        <button id="next-page" class="btn btn-secondary btn-small" disabled>Ê¨°„Å∏</button>
                    </div>
                </div>`;
            initializeTomSelect('#role-filter');

            let currentPage = 1;
            let currentSort = { by: 'displayName', order: 'asc' };
            
            const fetchAndRenderMembers = async () => {
                const search = document.getElementById('member-search').value;
                const roleFilter = document.getElementById('role-filter').value;
                document.getElementById('members-table-body').innerHTML = '<tr><td colspan="5" style="text-align:center;"><div class="loader-ring"></div></td></tr>';

                const data = await api.get(`/api/members?page=${currentPage}&search=${search}&sortBy=${currentSort.by}&sortOrder=${currentSort.order}&roleFilter=${roleFilter}`);
                const { members, totalPages } = data;
                
                const tableBody = document.getElementById('members-table-body');
                if (members.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">„É°„É≥„Éê„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ</td></tr>';
                } else {
                    tableBody.innerHTML = members.map(member => `
                        <tr data-member-id="${member.id}">
                            <td>
                                <div class="user-cell">
                                    <img src="${member.avatar}" alt="avatar">
                                    <div class="user-details">
                                        <span class="display-name">${member.displayName}</span>
                                        <span class="username">${member.username}</span>
                                    </div>
                                </div>
                            </td>
                            <td>${member.roles.map(r => `<span class="role-tag" style="border-left: 3px solid ${r.color};">${r.name}</span>`).join('')}</td>
                            <td>${new Date(member.joinedAt).toLocaleDateString()}</td>
                            <td>
                                <div><i data-feather="message-square" style="width:1em;height:1em;"></i> ${member.messageCount.toLocaleString()}</div>
                                <div><i data-feather="alert-triangle" style="width:1em;height:1em;"></i> ${member.warnCount}</div>
                            </td>
                            <td class="actions-cell">
                                <button class="btn btn-secondary btn-small manage-roles-btn"><i data-feather="shield"></i></button>
                                <button class="btn btn-danger btn-small kick-btn"><i data-feather="user-x"></i></button>
                                <button class="btn btn-danger btn-small ban-btn"><i data-feather="x-octagon"></i></button>
                            </td>
                        </tr>
                    `).join('');
                }
                feather.replace();
                addMemberActionListeners();

                document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prev-page').disabled = currentPage <= 1;
                document.getElementById('next-page').disabled = currentPage >= totalPages;
            };

            document.getElementById('prev-page').onclick = () => { if(currentPage > 1) { currentPage--; fetchAndRenderMembers(); }};
            document.getElementById('next-page').onclick = () => { currentPage++; fetchAndRenderMembers(); };
            document.getElementById('member-search').oninput = () => { currentPage = 1; fetchAndRenderMembers(); };
            document.getElementById('role-filter').onchange = () => { currentPage = 1; fetchAndRenderMembers(); };
            
            document.querySelectorAll('.styled-table thead th[data-sort]').forEach(th => {
                th.onclick = () => {
                    const sortBy = th.dataset.sort;
                    if (currentSort.by === sortBy) {
                        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.by = sortBy;
                        currentSort.order = 'asc';
                    }
                    fetchAndRenderMembers();
                };
            });
            fetchAndRenderMembers();
        },

        auditLog: async () => {
            pageTitle.textContent = 'Áõ£Êüª„É≠„Ç∞';
            const formatLogDetails = (log) => {
                const { eventType, details } = log;
                let content = '';
                switch(eventType) {
                    case 'MessageDelete':
                        content = `<strong>„ÉÅ„É£„É≥„Éç„É´:</strong> <#${details.channelId}>\n<div class="log-content">${details.content}</div>`;
                        break;
                    case 'MessageUpdate':
                        content = `<strong>„ÉÅ„É£„É≥„Éç„É´:</strong> <#${details.channelId}>\n<strong>Â§âÊõ¥Ââç:</strong><div class="log-content">${details.before}</div><strong>Â§âÊõ¥Âæå:</strong><div class="log-content">${details.after}</div>`;
                        break;
                    case 'NicknameUpdate':
                        content = `<strong>Â§âÊõ¥Ââç:</strong> ${details.before}\n<strong>Â§âÊõ¥Âæå:</strong> ${details.after}`;
                        break;
                    case 'RoleAdd':
                    case 'RoleRemove':
                        content = `<strong>„É≠„Éº„É´:</strong> ${details.roleName}`;
                        break;
                    default:
                        content = `<pre>${JSON.stringify(details, null, 2)}</pre>`;
                }
                return `<div class="log-details">${content}</div>`;
            };

            pageContent.innerHTML = `
                <div class="card">
                    <div class="card-header"><h3>Áõ£Êüª„É≠„Ç∞„Éì„É•„Éº„Ç¢</h3></div>
                     <div class="filter-bar">
                         <div class="form-group">
                            <input type="text" id="log-user-search" placeholder="„É¶„Éº„Ç∂„ÉºÂêç/„Çø„Ç∞„ÅßÊ§úÁ¥¢...">
                        </div>
                        <div class="form-group">
                            <select id="log-type-filter">
                                <option value="">„Åô„Åπ„Å¶„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥</option>
                                <option value="MessageDelete">„É°„ÉÉ„Çª„Éº„Ç∏ÂâäÈô§</option>
                                <option value="MessageUpdate">„É°„ÉÉ„Çª„Éº„Ç∏Á∑®ÈõÜ</option>
                                <option value="NicknameUpdate">„Éã„ÉÉ„ÇØ„Éç„Éº„É†Â§âÊõ¥</option>
                                <option value="RoleAdd">„É≠„Éº„É´‰ªò‰∏é</option>
                                <option value="RoleRemove">„É≠„Éº„É´Ââ•Â•™</option>
                            </select>
                        </div>
                    </div>
                     <div class="table-container">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>Êó•ÊôÇ</th>
                                    <th>„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                                    <th>ÂÆüË°åËÄÖ</th>
                                    <th>ÂØæË±°</th>
                                    <th>Ë©≥Á¥∞</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body"></tbody>
                        </table>
                    </div>
                    <div class="pagination-controls">
                        <button id="prev-page" class="btn btn-secondary btn-small" disabled>Ââç„Å∏</button>
                        <span id="page-info" class="page-info"></span>
                        <button id="next-page" class="btn btn-secondary btn-small" disabled>Ê¨°„Å∏</button>
                    </div>
                </div>`;
            initializeTomSelect('#log-type-filter');
            
            let currentPage = 1;
            const fetchAndRenderLogs = async () => {
                const user = document.getElementById('log-user-search').value;
                const eventType = document.getElementById('log-type-filter').value;
                document.getElementById('logs-table-body').innerHTML = '<tr><td colspan="5" style="text-align:center;"><div class="loader-ring"></div></td></tr>';
                
                const data = await api.get(`/api/audit-logs?page=${currentPage}&user=${user}&eventType=${eventType}`);
                const { logs, totalPages } = data;
                
                const tableBody = document.getElementById('logs-table-body');
                if(logs.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">„É≠„Ç∞„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ</td></tr>';
                } else {
                    tableBody.innerHTML = logs.map(log => `
                        <tr>
                            <td>${new Date(log.timestamp.seconds * 1000).toLocaleString()}</td>
                            <td>${log.eventType}</td>
                            <td>${log.executorTag || 'N/A'}</td>
                            <td>${log.targetTag || 'N/A'}</td>
                            <td>${formatLogDetails(log)}</td>
                        </tr>
                    `).join('');
                }
                document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prev-page').disabled = currentPage <= 1;
                document.getElementById('next-page').disabled = currentPage >= totalPages;
            };

            document.getElementById('prev-page').onclick = () => { if(currentPage > 1) { currentPage--; fetchAndRenderLogs(); }};
            document.getElementById('next-page').onclick = () => { currentPage++; fetchAndRenderLogs(); };
            document.getElementById('log-user-search').oninput = () => { currentPage = 1; fetchAndRenderLogs(); };
            document.getElementById('log-type-filter').onchange = () => { currentPage = 1; fetchAndRenderLogs(); };
            fetchAndRenderLogs();
        },

        analytics: async () => {
            pageTitle.textContent = '„Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ';
            pageContent.innerHTML = `
                <div class="grid-container" style="grid-template-columns: 2fr 1fr; gap: 30px;">
                    <div class="card">
                        <div class="card-header"><h3>ÊôÇÈñìÂ∏ØÂà•„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£</h3></div>
                        <div class="chart-container"><canvas id="activityChart"></canvas></div>
                    </div>
                     <div class="card">
                        <div class="card-header"><h3>„É≠„Éº„É´ÂàÜÂ∏É</h3></div>
                        <div class="chart-container"><canvas id="roleChart"></canvas></div>
                    </div>
                </div>
                 <div class="card">
                    <div class="card-header"><h3>„É°„ÉÉ„Çª„Éº„Ç∏Êï∞„É©„É≥„Ç≠„É≥„Ç∞ (TOP 10)</h3></div>
                    <ol id="leaderboard-list" class="leaderboard"></ol>
                </div>`;

            if (currentChart) currentChart.destroy();
            const data = await api.get('/api/analytics/activity');
            
            // Leaderboard
            const listEl = document.getElementById('leaderboard-list');
             if (data.topUsers.length === 0) {
                listEl.innerHTML = `<p style="text-align:center; color: var(--text-muted-color);">„Åæ„Å†„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>`;
            } else {
                listEl.innerHTML = data.topUsers.map((user, i) => `
                    <li>
                        <span class="rank">#${i + 1}</span>
                        <div class="user-info">
                            <div class="user-name">${user.displayName || user.username}</div>
                            <div class="user-id">${user.userId}</div>
                        </div>
                        <span class="stat">${user.messageCount.toLocaleString()} „É°„ÉÉ„Çª„Éº„Ç∏</span>
                    </li>`).join('');
            }
            
            // Activity Chart
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            new Chart(activityCtx, {
                type: 'bar',
                data: {
                    labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                    datasets: [{
                        label: '„É°„ÉÉ„Çª„Éº„Ç∏Êï∞',
                        data: data.activityByHour,
                        backgroundColor: 'rgba(0, 229, 255, 0.6)',
                        borderColor: 'rgba(0, 229, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });

            // Role Chart
            const roleCtx = document.getElementById('roleChart').getContext('2d');
            new Chart(roleCtx, {
                type: 'doughnut',
                data: {
                    labels: data.roleDistribution.map(r => r.name),
                    datasets: [{
                        label: '„É°„É≥„Éê„ÉºÊï∞',
                        data: data.roleDistribution.map(r => r.count),
                        backgroundColor: data.roleDistribution.map(r => r.color),
                        borderWidth: 1
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        },
        // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„Äê„Åì„Åì„Åæ„ÅßÂ§âÊõ¥„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ

        roleboard: async () => {
            pageTitle.textContent = '„É≠„Éº„É´„Éú„Éº„ÉâÁÆ°ÁêÜ';
            pageContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>„É≠„Éº„É´„Éú„Éº„Éâ‰∏ÄË¶ß</h3>
                        <button id="add-roleboard-btn" class="btn">Êñ∞Ë¶è‰ΩúÊàê</button>
                    </div>
                    <div id="roleboard-list"></div>
                </div>`;
            await renderRoleboardList();
            document.getElementById('add-roleboard-btn').addEventListener('click', showAddRoleboardModal);
        },

        announcements: async () => {
            pageTitle.textContent = '„ÅäÁü•„Çâ„ÅõË®≠ÂÆö';
            const settings = await api.get('/api/settings/guild_settings');
            settingsCache['guild_settings'] = settings;

            pageContent.innerHTML = `
                <form id="announcements-form">
                    <div class="card">
                        <div class="card-header">
                            <h3>„Éú„ÉÉ„Éà„Åã„Çâ„ÅÆ„ÅäÁü•„Çâ„ÅõÂèó‰ø°</h3>
                        </div>
                        <div class="form-group">
                            <label for="announcementChannelId">Âèó‰ø°„ÉÅ„É£„É≥„Éç„É´</label>
                            <select id="announcementChannelId" placeholder="„ÉÅ„É£„É≥„Éç„É´„ÇíÈÅ∏Êäû„Åó„Å™„ÅÑÔºàÂèó‰ø°„Åó„Å™„ÅÑÔºâ">
                                <option value="">ÈÅ∏Êäû„Åó„Å™„ÅÑ</option>
                                ${guildInfo.channels.filter(c => c.type === 0).map(o => `<option value="${o.id}">${o.name}</option>`).join('')}
                            </select>
                            <p class="form-hint">
                                „Éú„ÉÉ„Éà„ÅÆ„Ç¢„ÉÉ„Éó„Éá„Éº„ÉàÊÉÖÂ†±„ÇÑÈáçË¶Å„Å™„ÅäÁü•„Çâ„Åõ„Å™„Å©„ÄÅÈñãÁô∫ËÄÖ„Åã„Çâ„ÅÆ„ÅäÁü•„Çâ„Åõ„ÇíÂèó‰ø°„Åô„Çã„ÉÅ„É£„É≥„Éç„É´„ÇíÊåáÂÆö„Åó„Åæ„Åô„ÄÇ
                                <br>
                                ‰∏çË¶Å„Å™Â†¥Âêà„ÅØ„ÄÅ„ÉÅ„É£„É≥„Éç„É´„ÇíÈÅ∏Êäû„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
                            </p>
                        </div>
                    </div>
                    <button type="submit" class="btn">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                </form>
            `;
            initializeTomSelect('#announcementChannelId', { items: [settings.announcementChannelId] });
            document.getElementById('announcements-form').addEventListener('submit', handleFormSubmit);
            trackChanges('#announcements-form');
        },

        welcome: async () => {
            pageTitle.textContent = 'ÂèÇÂä†„ÉªÈÄÄÂá∫Ë®≠ÂÆö';
            const settings = await api.get('/api/settings/guilds');
            settingsCache['guilds'] = settings;
            const createSelectOptions = (options) => options.map(o => `<option value="${o.id}">${o.name}</option>`).join('');

            pageContent.innerHTML = `
                <form id="welcome-form">
                    <div class="card">
                        <div class="card-header"><h3>„ÉÅ„É£„É≥„Éç„É´Ë®≠ÂÆö</h3></div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="welcomeChannelId">„Ç¶„Çß„É´„Ç´„É†„ÉÅ„É£„É≥„Éç„É´</label>
                                <select id="welcomeChannelId" placeholder="„ÉÅ„É£„É≥„Éç„É´„ÇíÈÅ∏Êäû...">
                                    <option value="">ÈÅ∏Êäû„Åó„Å™„ÅÑ</option>
                                    ${createSelectOptions(guildInfo.channels.filter(c => c.type === 0))}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="goodbyeChannelId">„ÅäÂà•„Çå„ÉÅ„É£„É≥„Éç„É´</label>
                                <select id="goodbyeChannelId" placeholder="„ÉÅ„É£„É≥„Éç„É´„ÇíÈÅ∏Êäû...">
                                    <option value="">ÈÅ∏Êäû„Åó„Å™„ÅÑ</option>
                                    ${createSelectOptions(guildInfo.channels.filter(c => c.type === 0))}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="rulesChannelId">„É´„Éº„É´„ÉÅ„É£„É≥„Éç„É´</label>
                                <select id="rulesChannelId" placeholder="„ÉÅ„É£„É≥„Éç„É´„ÇíÈÅ∏Êäû...">
                                    <option value="">ÈÅ∏Êäû„Åó„Å™„ÅÑ</option>
                                    ${createSelectOptions(guildInfo.channels.filter(c => c.type === 0))}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Ê©üËÉΩË®≠ÂÆö</h3></div>
                        <div class="form-group">
                            <label for="welcomeRoleId">„Ç¶„Çß„É´„Ç´„É†„É≠„Éº„É´</label>
                            <select id="welcomeRoleId" placeholder="„É≠„Éº„É´„ÇíÈÅ∏Êäû...">
                                <option value="">ÈÅ∏Êäû„Åó„Å™„ÅÑ</option>
                                ${createSelectOptions(guildInfo.roles)}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>„Ç¶„Çß„É´„Ç´„É†ÊôÇ„É°„É≥„Ç∑„Éß„É≥</label>
                            <label class="switch">
                                <input type="checkbox" id="mentionOnWelcome" ${settings.mentionOnWelcome ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>ÈÄÄÂá∫ÊôÇDMÈÄÅ‰ø°</label>
                            <label class="switch">
                                <input type="checkbox" id="sendGoodbyeDM" ${settings.sendGoodbyeDM !== false ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                </form>`;
            ['welcomeChannelId', 'goodbyeChannelId', 'rulesChannelId', 'welcomeRoleId'].forEach(id =>
                initializeTomSelect(`#${id}`, { items: [settings[id]] })
            );
            document.getElementById('welcome-form').addEventListener('submit', handleFormSubmit);
            trackChanges('#welcome-form');
        },
        
        // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„Äê„Åì„Åì„Åã„ÇâÂ§âÊõ¥„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
        'welcome-message': async () => {
            pageTitle.textContent = '„Ç¶„Çß„É´„Ç´„É†„É°„ÉÉ„Çª„Éº„Ç∏Ë®≠ÂÆö';
            const settings = await api.get('/api/settings/welcome-message');
            settingsCache['welcome-message'] = settings;

            const updatePreview = () => {
                const type = document.getElementById('welcome-type').value;
                const title = document.getElementById('welcome-title').value;
                const desc = document.getElementById('welcome-description').value;
                const imageUrl = document.getElementById('welcome-imageUrl').value;
                const color = document.getElementById('welcome-color-picker').value;

                const previewTitle = document.getElementById('preview-title');
                const previewDesc = document.getElementById('preview-desc');
                const previewThumb = document.getElementById('preview-thumb');
                const previewImage = document.getElementById('preview-image');
                const previewSidebar = document.querySelector('.discord-embed-preview .embed-sidebar');

                const dummyData = {
                    'user.name': 'TestUser',
                    'user.displayName': '„ÉÜ„Çπ„Éà„É¶„Éº„Ç∂„Éº',
                    'user.mention': '@„ÉÜ„Çπ„Éà„É¶„Éº„Ç∂„Éº',
                    'server.name': guildInfo.name,
                    'server.memberCount': guildInfo.memberCount.toLocaleString(),
                    'rulesChannel': '#rules'
                };
                
                const replaceVars = (text) => text.replace(/{(\w+\.\w+)}/g, (match, key) => dummyData[key] || match);

                if (type === 'gemini') {
                    previewTitle.textContent = 'üéâ AI„Å´„Çà„ÇãËá™ÂãïÁîüÊàê';
                    previewDesc.textContent = 'AI„Åå„Çµ„Éº„Éê„ÉºÂêç„ÇÑ„É¶„Éº„Ç∂„ÉºÂêç„Çí‰Ωø„Å£„Å¶„ÄÅ„É¶„Éã„Éº„ÇØ„Å™Ê≠ìËøé„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËá™Âãï„Åß‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ';
                    previewImage.style.display = 'none';
                } else {
                    previewTitle.textContent = replaceVars(title);
                    previewDesc.textContent = replaceVars(desc);
                    previewImage.src = imageUrl;
                    previewImage.style.display = imageUrl ? 'block' : 'none';
                }
                previewSidebar.style.backgroundColor = color;
            };

            pageContent.innerHTML = `
                <div class="welcome-message-layout">
                    <form id="welcome-message-form">
                        <div class="card">
                            <div class="card-header"><h3>„É°„ÉÉ„Çª„Éº„Ç∏Ë®≠ÂÆö</h3></div>
                            <div class="form-group">
                                <label>„Ç´„Çπ„Çø„É†„Ç¶„Çß„É´„Ç´„É†„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊúâÂäπÂåñ</label>
                                <label class="switch"><input type="checkbox" id="welcome-enabled" ${settings.enabled ? 'checked' : ''}><span class="slider"></span></label>
                            </div>
                            <div class="form-group">
                                <label for="welcome-type">„É°„ÉÉ„Çª„Éº„Ç∏„Çø„Ç§„Éó</label>
                                <select id="welcome-type">
                                    <option value="default" ${settings.type === 'default' ? 'selected' : ''}>„Ç´„Çπ„Çø„É†</option>
                                    <option value="gemini" ${settings.type === 'gemini' ? 'selected' : ''}>AI (Gemini) ÁîüÊàê</option>
                                </select>
                            </div>
                        </div>
                        <div id="default-settings">
                            <div class="card">
                                <div class="card-header"><h3>„É°„ÉÉ„Çª„Éº„Ç∏ÂÜÖÂÆπ</h3></div>
                                <div class="form-group">
                                    <label for="welcome-title">„Çø„Ç§„Éà„É´</label>
                                    <input type="text" id="welcome-title" value="${settings.title || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="welcome-description">Ë™¨ÊòéÊñá</label>
                                    <textarea id="welcome-description" rows="6">${settings.description || ''}</textarea>
                                    <p class="form-hint"><b>Â§âÊï∞:</b> <code>{user.displayName}</code>, <code>{user.mention}</code>, <code>{server.name}</code>, <code>{server.memberCount}</code>, <code>{rulesChannel}</code></p>
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="welcome-imageUrl">ÁîªÂÉèURL</label>
                                        <input type="text" id="welcome-imageUrl" placeholder="https://..." value="${settings.imageUrl || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label for="modal-color">Âüã„ÇÅËæº„Åø„ÅÆËâ≤</label>
                                        <div class="color-input-wrapper">
                                            <input type="color" id="welcome-color-picker" value="${settings.color || '#00FF00'}">
                                            <input type="text" id="welcome-color-text" value="${settings.color || '#00FF00'}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                    </form>
                    <div class="card">
                         <div class="card-header"><h3>„É™„Ç¢„É´„Çø„Ç§„É†„Éó„É¨„Éì„É•„Éº</h3></div>
                         <div class="discord-embed-preview">
                            <div class="embed-sidebar"></div>
                            <div class="embed-content">
                                <div class="embed-author" style="display:flex; align-items:center; gap:8px;">
                                    <img id="preview-thumb" src="https://cdn.discordapp.com/embed/avatars/0.png" style="width:24px; height:24px; border-radius:50%;">
                                    <span>Overseer Bot</span>
                                </div>
                                <div id="preview-title" class="embed-title"></div>
                                <div id="preview-desc" class="embed-description"></div>
                                <img id="preview-image" src="" class="embed-thumbnail" style="display:none; max-width:100%; border-radius:6px;">
                            </div>
                         </div>
                    </div>
                </div>`;

            initializeTomSelect('#welcome-type');

            const form = document.getElementById('welcome-message-form');
            const toggleSettingsVisibility = () => {
                document.getElementById('default-settings').style.display = document.getElementById('welcome-type').value === 'default' ? 'block' : 'none';
                updatePreview();
            };
            
            form.addEventListener('input', updatePreview);
            form.addEventListener('change', toggleSettingsVisibility);

            const colorPicker = form.querySelector('#welcome-color-picker');
            const colorText = form.querySelector('#welcome-color-text');
            colorPicker.oninput = () => { colorText.value = colorPicker.value.toUpperCase(); updatePreview(); };
            colorText.oninput = () => { if (/^#[0-9A-F]{6}$/i.test(colorText.value)) { colorPicker.value = colorText.value; updatePreview(); } };
            
            toggleSettingsVisibility();
            document.getElementById('welcome-message-form').addEventListener('submit', handleFormSubmit);
            trackChanges('#welcome-message-form');
        },
        // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ„Äê„Åì„Åì„Åæ„ÅßÂ§âÊõ¥„Äë‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ


        autorole: async () => {
            pageTitle.textContent = 'Bot Ëá™Âãï„É≠„Éº„É´Ë®≠ÂÆö';
            const settings = await api.get('/api/settings/guild_settings');
            settingsCache['guild_settings'] = settings;
            pageContent.innerHTML = `
                <form id="autorole-form">
                    <div class="card">
                        <div class="card-header"><h3>BotÁî®„É≠„Éº„É´</h3></div>
                        <div class="form-group">
                            <label for="botAutoroleId">Ëá™Âãï‰ªò‰∏é„É≠„Éº„É´</label>
                            <select id="botAutoroleId" placeholder="„É≠„Éº„É´„ÇíÈÅ∏Êäû...">
                                <option value="">ÈÅ∏Êäû„Åó„Å™„ÅÑ</option>
                                ${guildInfo.roles.map(o => `<option value="${o.id}">${o.name}</option>`).join('')}
                            </select>
                            <p class="form-hint">Êñ∞„Åó„ÅÑBot„ÅåÂèÇÂä†„Åó„ÅüÈöõ„ÄÅÈÅ∏Êäû„Åó„Åü„É≠„Éº„É´„ÅåËá™Âãï‰ªò‰∏é„Åï„Çå„Åæ„Åô„ÄÇ</p>
                        </div>
                    </div>
                    <button type="submit" class="btn">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                </form>`;
            initializeTomSelect('#botAutoroleId', { items: [settings.botAutoroleId] });
            document.getElementById('autorole-form').addEventListener('submit', handleFormSubmit);
            trackChanges('#autorole-form');
        },

        automod: async () => {
            pageTitle.textContent = '„Ç™„Éº„Éà„É¢„ÉÉ„ÉâË®≠ÂÆö';
            const settings = await api.get('/api/settings/guild_settings');
            settingsCache['guild_settings'] = settings;
            const automod = settings.automod || { ngWords: [], blockInvites: true };
            pageContent.innerHTML = `
                <form id="automod-form">
                    <div class="card">
                        <div class="card-header"><h3>NG„ÉØ„Éº„Éâ„Éï„Ç£„É´„Çø„Éº</h3></div>
                        <div class="form-group">
                            <label for="ngWords">NG„ÉØ„Éº„Éâ („Ç´„É≥„ÉûÂå∫Âàá„Çä)</label>
                            <textarea id="ngWords" rows="4" placeholder="word1,word2">${(automod.ngWords || []).join(',')}</textarea>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>ÊãõÂæÖ„É™„É≥„ÇØ„Éï„Ç£„É´„Çø„Éº</h3></div>
                        <div class="form-group">
                            <label>ÊãõÂæÖ„É™„É≥„ÇØ„Çí„Éñ„É≠„ÉÉ„ÇØ</label>
                            <label class="switch">
                                <input type="checkbox" id="blockInvites" ${automod.blockInvites !== false ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                </form>`;
            document.getElementById('automod-form').addEventListener('submit', handleFormSubmit);
            trackChanges('#automod-form');
        },

        logging: async () => {
            pageTitle.textContent = '„É≠„Ç∞Ë®≠ÂÆö';
            const settings = await api.get('/api/settings/guild_settings');
            settingsCache['guild_settings'] = settings;
            pageContent.innerHTML = `
                <form id="logging-form">
                    <div class="card">
                        <div class="card-header"><h3>Áõ£Êüª„É≠„Ç∞</h3></div>
                        <div class="form-group">
                            <label for="auditLogChannel">Áõ£Êüª„É≠„Ç∞„ÉÅ„É£„É≥„Éç„É´</label>
                            <select id="auditLogChannel" placeholder="„ÉÅ„É£„É≥„Éç„É´„ÇíÈÅ∏Êäû...">
                                <option value="">ÈÅ∏Êäû„Åó„Å™„ÅÑ</option>
                                ${guildInfo.channels.filter(c => c.type === 0).map(o => `<option value="${o.id}">${o.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                </form>`;
            initializeTomSelect('#auditLogChannel', { items: [settings.auditLogChannel] });
            document.getElementById('logging-form').addEventListener('submit', handleFormSubmit);
            trackChanges('#logging-form');
        },

        'vc-log': async () => {
            pageTitle.textContent = 'VC„É≠„Ç∞Ë®≠ÂÆö';
            const settings = await api.get('/api/settings/guild_settings');
            settingsCache['guild_settings'] = settings;
            let mappings = settings.voiceChannelMappings || {};

            const renderMappings = () => {
                const listEl = document.getElementById('vc-log-mapping-list');
                if (Object.keys(mappings).length === 0) {
                    listEl.innerHTML = '<p style="text-align:center; color: var(--text-muted-color);">„Åæ„Å†VC„É≠„Ç∞Ë®≠ÂÆö„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
                    return;
                }
                listEl.innerHTML = Object.entries(mappings).map(([vcId, tcId]) => {
                    const vc = guildInfo.channels.find(c => c.id === vcId);
                    const tc = guildInfo.channels.find(c => c.id === tcId);
                    if (!vc || !tc) return ''; // „ÉÅ„É£„É≥„Éç„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØË°®Á§∫„Åó„Å™„ÅÑ
                    return `
                        <div class="vc-log-mapping-item" data-vc-id="${vcId}">
                            <div class="vc-log-mapping-channels">
                                <div class="channel-name"><i data-feather="mic"></i><span>${vc.name}</span></div>
                                <i data-feather="arrow-right"></i>
                                <div class="channel-name"><i data-feather="message-square"></i><span>${tc.name}</span></div>
                            </div>
                            <button class="btn btn-danger btn-small remove-mapping-btn">&times;</button>
                        </div>
                    `;
                }).join('');
                feather.replace();
                listEl.querySelectorAll('.remove-mapping-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const vcId = e.target.closest('.vc-log-mapping-item').dataset.vcId;
                        delete mappings[vcId];
                        renderMappings();
                        isDirty = true;
                    };
                });
            };

            pageContent.innerHTML = `
                <form id="vc-log-form">
                    <div class="card">
                        <div class="card-header"><h3>ÁèæÂú®„ÅÆË®≠ÂÆö</h3></div>
                        <div id="vc-log-mapping-list" class="vc-log-mapping-list"></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Êñ∞„Åó„ÅÑË®≠ÂÆö„ÇíËøΩÂä†</h3></div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="voice-channel-select">„Éú„Ç§„Çπ„ÉÅ„É£„É≥„Éç„É´</label>
                                <select id="voice-channel-select" placeholder="VC„ÇíÈÅ∏Êäû..."></select>
                            </div>
                            <div class="form-group">
                                <label for="text-channel-select">„É≠„Ç∞ÈÄÅ‰ø°ÂÖà„ÉÅ„É£„É≥„Éç„É´</label>
                                <select id="text-channel-select" placeholder="TC„ÇíÈÅ∏Êäû..."></select>
                            </div>
                        </div>
                        <button type="button" id="add-mapping-btn" class="btn btn-secondary">„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíËøΩÂä†</button>
                    </div>
                    <button type="submit" class="btn">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                </form>`;

            const voiceChannels = guildInfo.channels.filter(c => c.type === 2);
            const textChannels = guildInfo.channels.filter(c => c.type === 0);
            
            initializeTomSelect('#voice-channel-select', { options: voiceChannels.map(c => ({ value: c.id, text: c.name })) });
            initializeTomSelect('#text-channel-select', { options: textChannels.map(c => ({ value: c.id, text: c.name })) });
            
            renderMappings();

            document.getElementById('add-mapping-btn').onclick = () => {
                const vcSelect = document.getElementById('voice-channel-select').tomselect;
                const tcSelect = document.getElementById('text-channel-select').tomselect;
                const vcId = vcSelect.getValue();
                const tcId = tcSelect.getValue();

                if (!vcId || !tcId) {
                    showMessage('‰∏°Êñπ„ÅÆ„ÉÅ„É£„É≥„Éç„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                    return;
                }
                mappings[vcId] = tcId;
                renderMappings();
                vcSelect.clear();
                tcSelect.clear();
                isDirty = true;
            };

            document.getElementById('vc-log-form').addEventListener('submit', (e) => {
                 e.preventDefault();
                 handleFormSubmit(e, { voiceChannelMappings: mappings });
            });
            trackChanges('#vc-log-form');
        },


        leveling: async () => {
            pageTitle.textContent = '„É¨„Éô„É™„É≥„Ç∞Ë®≠ÂÆö';
            const settings = await api.get('/api/settings/guild_settings');
            settingsCache['guild_settings'] = settings;
            const levelingSettings = settings.leveling || { roleRewards: [] };
            pageContent.innerHTML = `
                <form id="leveling-form">
                    <div class="card">
                        <div class="card-header"><h3>„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÈÄöÁü•</h3></div>
                        <div class="form-group">
                            <label for="levelUpChannel">ÈÄöÁü•„ÉÅ„É£„É≥„Éç„É´</label>
                            <select id="levelUpChannel" placeholder="„É¨„Éô„É´„Ç¢„ÉÉ„Éó„Åó„Åü„ÉÅ„É£„É≥„Éç„É´„Å´ÈÄöÁü•">
                                <option value="">„É¨„Éô„É´„Ç¢„ÉÉ„Éó„Åó„Åü„ÉÅ„É£„É≥„Éç„É´„Å´ÈÄöÁü•</option>
                                ${guildInfo.channels.filter(c => c.type === 0).map(o => `<option value="${o.id}">${o.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>„É≠„Éº„É´Â†±ÈÖ¨</h3></div>
                        <div id="role-rewards-list"></div>
                        <div class="form-group" style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:20px;">
                            <label>Êñ∞„Åó„ÅÑÂ†±ÈÖ¨„ÇíËøΩÂä†</label>
                            <div class="form-grid" style="align-items:flex-end;">
                                <input type="number" id="reward-level" placeholder="„É¨„Éô„É´" min="1">
                                <select id="reward-role-id" placeholder="„É≠„Éº„É´„ÇíÈÅ∏Êäû...">
                                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                    ${guildInfo.roles.map(o => `<option value="${o.id}">${o.name}</option>`).join('')}
                                </select>
                                <button type="button" id="add-reward-btn" class="btn">ËøΩÂä†</button>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                </form>`;
            initializeTomSelect('#levelUpChannel', { items: [settings.levelUpChannel] });
            initializeTomSelect('#reward-role-id');

            const renderRoleRewards = () => {
                const listEl = document.getElementById('role-rewards-list');
                if (!levelingSettings.roleRewards || levelingSettings.roleRewards.length === 0) {
                    listEl.innerHTML = '<p style="text-align:center; color: var(--text-muted-color);">„É≠„Éº„É´Â†±ÈÖ¨„ÅØ„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>';
                    return;
                }
                listEl.innerHTML = levelingSettings.roleRewards
                    .sort((a, b) => a.level - b.level)
                    .map((reward, index) => `
                        <div class="role-item" data-index="${index}">
                            <div class="role-info">
                                <span class="role-name">Lv. ${reward.level}</span>
                                <span class="role-genre-tag">${guildInfo.roles.find(r => r.id === reward.roleId)?.name || '‰∏çÊòé'}</span>
                            </div>
                            <button type="button" class="btn btn-danger btn-small remove-reward-btn">&times;</button>
                        </div>`).join('');
                listEl.querySelectorAll('.remove-reward-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        levelingSettings.roleRewards.splice(parseInt(e.target.closest('.role-item').dataset.index, 10), 1);
                        renderRoleRewards();
                        isDirty = true;
                    };
                });
            };
            renderRoleRewards();

            document.getElementById('add-reward-btn').onclick = () => {
                const level = parseInt(document.getElementById('reward-level').value, 10);
                const roleId = document.getElementById('reward-role-id').value;
                if (!level || !roleId || level < 1) {
                    return showMessage('ÊúâÂäπ„Å™„É¨„Éô„É´„Å®„É≠„Éº„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                }
                if (levelingSettings.roleRewards.some(r => r.level === level)) {
                    return showMessage(`„É¨„Éô„É´ ${level} „ÅÆÂ†±ÈÖ¨„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ`, 'error');
                }
                levelingSettings.roleRewards.push({ level, roleId });
                renderRoleRewards();
                document.getElementById('reward-level').value = '';
                document.getElementById('reward-role-id').tomselect.clear();
                isDirty = true;
            };

            document.getElementById('leveling-form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleFormSubmit(e, {
                    levelUpChannel: document.getElementById('levelUpChannel').value || null,
                    leveling: levelingSettings
                });
            });
            trackChanges('#leveling-form');
        },

        ai: async () => {
            pageTitle.textContent = 'AIË®≠ÂÆö';
            const settings = await api.get('/api/settings/guild_settings');
            settingsCache['guild_settings'] = settings;
            const aiConfig = settings.ai || { mentionReplyEnabled: true, aiPersonalityPrompt: '' };
            const personaTemplates = [
                {
                    name: 'üê± Áå´„Ç¢„Ç∑„Çπ„Çø„É≥„Éà',
                    prompt: '„ÅÇ„Å™„Åü„ÅØ„ÄåOverseer„Äç„Å®„ÅÑ„ÅÜÂêçÂâç„ÅÆ„ÄÅÁå´„Å´„Å™„Çä„Åç„Å£„Å¶„ÅÑ„Çã„Ç¢„Ç∑„Çπ„Çø„É≥„ÉàAI„Åß„Åô„ÄÇ\n' +
                            '# „ÅÇ„Å™„Åü„ÅÆÂΩπÂâ≤\n' +
                            '- Ë™ûÂ∞æ„Å´„ÅØÂøÖ„Åö„Äå„Å´„ÇÉ„Çì„Äç„ÇÑ„Äå„Å´„ÇÉ„Äç„Çí„Å§„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n' +
                            '- ‰∏Ä‰∫∫Áß∞„ÅØ„ÄåÂêæËº©„Äç„Åß„Åô„ÄÇ\n' +
                            '- „É¶„Éº„Ç∂„Éº„ÅÆ„Åì„Å®„ÅØ„Äå„Åî‰∏ª‰∫∫Êßò„Äç„Å®Âëº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ\n' +
                            '- Â∞ë„ÅóÊ∞ó„Åæ„Åê„Çå„Åß„Åô„Åå„ÄÅË¶™Âàá„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                },
                {
                    name: 'ü§ñ Âü∑‰∫ãAI',
                    prompt: '„ÅÇ„Å™„Åü„ÅØ„ÄåOverseer„Äç„Å®„ÅÑ„ÅÜÂêçÂâç„ÅÆ„ÄÅÈùûÂ∏∏„Å´‰∏ÅÂØß„ÅßÊúâËÉΩ„Å™Âü∑‰∫ãAI„Åß„Åô„ÄÇ\n' +
                            '# „ÅÇ„Å™„Åü„ÅÆÂΩπÂâ≤\n' +
                            '- Â∏∏„Å´Êï¨Ë™û„Çí‰Ωø„ÅÑ„ÄÅ‰∏ÅÂØß„Å™Ë®ÄËëâÈÅ£„ÅÑ„ÇíÂæπÂ∫ï„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n' +
                            '- ‰∏Ä‰∫∫Áß∞„ÅØ„ÄåÁßÅÔºà„Çè„Åü„Åè„ÅóÔºâ„Äç„Åß„Åô„ÄÇ\n' +
                            '- „É¶„Éº„Ç∂„Éº„ÅÆ„Åì„Å®„ÅØ„ÄåÊßò„Äç‰ªò„Åë„ÅßÂëº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇÔºà‰æã: „Äá„ÄáÊßòÔºâ\n' +
                            '- „Å©„Çì„Å™Ë≥™Âïè„Å´„ÇÇÂÜ∑ÈùôÊ≤àÁùÄ„Åã„Å§ÁöÑÁ¢∫„Å´Á≠î„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                },
                {
                    name: '‚öîÔ∏è Ê≠¶Â£´',
                    prompt: '„ÅÇ„Å™„Åü„ÅØ„ÄåOverseer„Äç„Å®„ÅÑ„ÅÜÂêçÂâç„ÅÆ„ÄÅÂè§È¢®„Å™Ê≠¶Â£´„ÅÆ„Çà„ÅÜ„Å™AI„Åß„Åô„ÄÇ\n' +
                            '# „ÅÇ„Å™„Åü„ÅÆÂΩπÂâ≤\n' +
                            '- Ë™ûÂ∞æ„ÅØ„ÄåÔΩû„Åß„Åî„Åñ„Çã„Äç„ÄåÔΩû„Åõ„Å¨„ÅãÔºü„Äç„Å™„Å©„ÄÅÊ≠¶Â£´„ÅÆ„Çà„ÅÜ„Å™Âè£Ë™ø„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n' +
                            '- ‰∏Ä‰∫∫Áß∞„ÅØ„ÄåÊãôËÄÖ„Äç„Åß„Åô„ÄÇ\n' +
                            '- „É¶„Éº„Ç∂„Éº„ÅÆ„Åì„Å®„ÅØ„ÄåÊÆø„Äç„Å®Âëº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ\n' +
                            '- Áæ©ÁêÜÂ†Ö„Åè„ÄÅË™†ÂÆü„Å´ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                },
                {
                    name: 'ü§™ ÈôΩÊ∞ó„Å™Áõ∏Ê£í',
                    prompt: '„ÅÇ„Å™„Åü„ÅØ„ÄåOverseer„Äç„Å®„ÅÑ„ÅÜÂêçÂâç„ÅÆ„ÄÅÈùûÂ∏∏„Å´ÈôΩÊ∞ó„Åß„Éï„É¨„É≥„Éâ„É™„Éº„Å™AI„Åß„Åô„ÄÇ\n' +
                            '# „ÅÇ„Å™„Åü„ÅÆÂΩπÂâ≤\n' +
                            '- Êòé„Çã„Åè„ÄÅ„Çø„É°Âè£„ÅÆ„Çà„ÅÜ„Å™Ë¶™„Åó„Åø„ÇÑ„Åô„ÅÑÂè£Ë™ø„ÅßË©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n' +
                            '- ‰∏Ä‰∫∫Áß∞„ÅØ„Äå„Ç™„É¨„Äç„Åß„Åô„ÄÇ\n' +
                            '- „É¶„Éº„Ç∂„Éº„ÅÆ„Åì„Å®„ÅØÂëº„Å≥Êç®„Å¶„Åã„ÄåÁõ∏Ê£í„Äç„Å®Âëº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ\n' +
                            '- ÊôÇ„ÄÖ„Ç∏„Éß„Éº„ÇØ„Çí‰∫§„Åà„Å™„Åå„Çâ„ÄÅÊ•Ω„Åó„Åè‰ºöË©±„ÇíÁõõ„Çä‰∏ä„Åí„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                }
            ];

            pageContent.innerHTML = `
                <form id="ai-form">
                    <div class="card">
                        <div class="card-header"><h3>„É°„É≥„Ç∑„Éß„É≥ÂøúÁ≠îÊ©üËÉΩ</h3></div>
                        <div class="form-group">
                            <label>„É°„É≥„Ç∑„Éß„É≥„Å∏„ÅÆËá™ÂãïÂøúÁ≠î</label>
                            <label class="switch">
                                <input type="checkbox" id="mentionReplyEnabled" ${aiConfig.mentionReplyEnabled ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                            <p class="form-hint">Bot„Å´„É°„É≥„Ç∑„Éß„É≥„Åô„Çã„Å®AI„ÅåËøî‰ø°„Åó„Åæ„Åô„ÄÇ</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>AI„ÅÆ„Éö„É´„ÇΩ„ÉäË®≠ÂÆö</h3></div>
                        <div class="form-group">
                            <label for="aiPersonalityPrompt">AI„Å∏„ÅÆÊåáÁ§∫Ôºà„Éó„É≠„É≥„Éó„ÉàÔºâ</label>
                            <textarea id="aiPersonalityPrompt" rows="8" placeholder="‰æãÔºö„ÅÇ„Å™„Åü„ÅØÁå´„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„Åß„Åô„ÄÇË™ûÂ∞æ„Å´„Äå„Å´„ÇÉ„Çì„Äç„Çí‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ">${aiConfig.aiPersonalityPrompt || ''}</textarea>
                            <p class="form-hint">AI„ÅÆÊÄßÊ†º„ÇÑÂè£Ë™ø„ÇíÊåáÂÆö„Åß„Åç„Åæ„Åô„ÄÇÁ©∫Ê¨Ñ„ÅÆÂ†¥Âêà„ÅØ„Éï„É¨„É≥„Éâ„É™„Éº„Å™„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Å´„Å™„Çä„Åæ„Åô„ÄÇ</p>
                        </div>
                        
                        <div class="form-group" style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:20px;">
                            <label>„Éö„É´„ÇΩ„ÉäË®≠ÂÆö„Ç¢„Ç∑„Çπ„Çø„É≥„Éà</label>
                            <p class="form-hint">„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„ÄÅ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰∏ä„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´ÊåøÂÖ•„Åó„Åæ„Åô„ÄÇ</p>
                            <div id="persona-templates" class="persona-templates-container">
                                ${personaTemplates.map(template => `<button type="button" class="btn btn-secondary btn-small" data-prompt="${template.prompt.replace(/"/g, '&quot;')}">${template.name}</button>`).join('')}
                            </div>
                        </div>

                    </div>
                    <button type="submit" class="btn">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                </form>`;

            document.querySelectorAll('#persona-templates button').forEach(button => {
                button.addEventListener('click', () => {
                    const prompt = button.getAttribute('data-prompt');
                    const textarea = document.getElementById('aiPersonalityPrompt');
                    textarea.value = prompt;
                    textarea.dispatchEvent(new Event('input', { bubbles: true }));
                });
            });
            document.getElementById('ai-form').addEventListener('submit', handleFormSubmit);
            trackChanges('#ai-form');
        },
    };

    // --- Roleboard Functions ---
    const renderRoleboardList = async () => {
        const listEl = document.getElementById('roleboard-list');
        listEl.innerHTML = '<div class="loader-ring" style="margin: 20px auto;"></div>';
        try {
            const boards = await api.get('/api/roleboards');
            if (boards.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--text-muted-color);">„Åæ„Å†„É≠„Éº„É´„Éú„Éº„Éâ„Åå‰ΩúÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>';
                return;
            }
            listEl.innerHTML = boards.map(board => `
                <div class="card">
                    <div class="card-header">
                        <h3>${board.title}</h3>
                        <div>
                            <button class="btn btn-secondary btn-small edit-roleboard-btn" data-id="${board.id}">Á∑®ÈõÜ</button>
                            <button class="btn btn-danger btn-small delete-roleboard-btn" data-id="${board.id}">ÂâäÈô§</button>
                        </div>
                    </div>
                    <p>${board.description}</p>
                    <p><strong>„É≠„Éº„É´Êï∞:</strong> ${Object.keys(board.roles || {}).length}</p>
                </div>`).join('');
            listEl.querySelectorAll('.edit-roleboard-btn').forEach(btn =>
                btn.onclick = (e) => showEditRoleboardModal(e.target.dataset.id)
            );
            listEl.querySelectorAll('.delete-roleboard-btn').forEach(btn =>
                btn.onclick = (e) => confirmDeleteRoleboard(e.target.dataset.id)
            );
        } catch (error) {
            listEl.innerHTML = `<p class="message error">Ë™≠ËæºÂ§±Êïó: ${error.message}</p>`;
        }
    };

    const showAddRoleboardModal = () => {
        const modal = createModal('Êñ∞„Åó„ÅÑ„É≠„Éº„É´„Éú„Éº„Éâ„Çí‰ΩúÊàê', `
            <div class="form-group">
                <label for="modal-title">„Çø„Ç§„Éà„É´</label>
                <input type="text" id="modal-title" required>
            </div>
            <div class="form-group">
                <label for="modal-description">Ë™¨Êòé</label>
                <textarea id="modal-description"></textarea>
            </div>
            <div class="form-group">
                <label for="modal-color">Âüã„ÇÅËæº„Åø„ÅÆËâ≤</label>
                <div class="color-input-wrapper">
                    <input type="color" id="modal-color-picker" value="#5865F2">
                    <input type="text" id="modal-color-text" value="#5865F2">
                </div>
            </div>`,
            [{ id: 'save-new-board', text: '‰ΩúÊàê', class: 'btn' }]
        );

        const colorPicker = modal.querySelector('#modal-color-picker');
        const colorText = modal.querySelector('#modal-color-text');
        colorPicker.oninput = () => colorText.value = colorPicker.value;
        colorText.oninput = () => {
            if (/^#[0-9A-F]{6}$/i.test(colorText.value)) {
                colorPicker.value = colorText.value;
            }
        };

        document.getElementById('save-new-board').onclick = async () => {
            const title = modal.querySelector('#modal-title').value.trim();
            if (!title) {
                return showMessage('„Çø„Ç§„Éà„É´„ÅØÂøÖÈ†à„Åß„Åô„ÄÇ', 'error');
            }
            try {
                await api.post('/api/roleboards', {
                    title,
                    description: modal.querySelector('#modal-description').value.trim(),
                    color: colorText.value
                });
                showMessage('„É≠„Éº„É´„Éú„Éº„Éâ„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü„ÄÇ');
                closeModal();
                await renderRoleboardList();
            } catch (error) {
                showMessage(`‰ΩúÊàê„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        };
    };

    const showEditRoleboardModal = async (boardId) => {
        try {
            const boards = await api.get('/api/roleboards');
            const board = boards.find(b => b.id === boardId);
            if (!board) {
                return showMessage('„Éú„Éº„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
            }

            const modal = createModal('„É≠„Éº„É´„Éú„Éº„Éâ„ÇíÁ∑®ÈõÜ', `
                <div class="form-grid">
                    <div class="form-group">
                        <label>„Çø„Ç§„Éà„É´</label>
                        <input type="text" id="edit-title" value="${board.title || ''}">
                    </div>
                    <div class="form-group">
                        <label>Ëâ≤</label>
                        <div class="color-input-wrapper">
                            <input type="color" id="edit-color-picker" value="#${(board.color || 0x5865F2).toString(16).padStart(6, '0').toUpperCase()}">
                            <input type="text" id="edit-color-text" value="#${(board.color || 0x5865F2).toString(16).padStart(6, '0').toUpperCase()}">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ë™¨Êòé</label>
                    <textarea id="edit-desc">${board.description || ''}</textarea>
                </div>
                <hr style="border-color: var(--border-color); margin: 20px 0;">
                <h4>„É≠„Éº„É´ÁÆ°ÁêÜ</h4>
                <div id="modal-role-list"></div>
                <div class="form-group" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                    <label>„É≠„Éº„É´„ÇíËøΩÂä†</label>
                    <div class="add-role-grid">
                        <div class="form-group">
                            <select id="add-role-select" placeholder="„É≠„Éº„É´„ÇíÈÅ∏Êäû...">
                                <option value="">„É≠„Éº„É´„ÇíÈÅ∏Êäû...</option>
                                ${guildInfo.roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                           <input type="text" id="add-role-genre" placeholder="„Ç∏„É£„É≥„É´">
                        </div>
                         <div class="form-group add-role-btn-wrapper">
                            <button id="add-role-btn" class="btn">ËøΩÂä†</button>
                        </div>
                    </div>
                </div>`,
                [{ id: 'save-board-changes', text: '‰øùÂ≠ò', class: 'btn' }]
            );

            const colorPicker = modal.querySelector('#edit-color-picker');
            const colorText = modal.querySelector('#edit-color-text');
            colorPicker.oninput = () => colorText.value = colorPicker.value.toUpperCase();
            colorText.oninput = () => {
                if (/^#[0-9A-F]{6}$/i.test(colorText.value)) {
                    colorPicker.value = colorText.value;
                }
            };

            const localBoard = JSON.parse(JSON.stringify(board));

            const selectEl = modal.querySelector('#add-role-select');
            initializeTomSelect(selectEl);

            const renderModalRoleList = () => {
                const listEl = document.getElementById('modal-role-list');
                const roles = localBoard.roles || {};
                if (Object.keys(roles).length === 0) {
                    listEl.innerHTML = '<p style="text-align: center; color: var(--text-muted-color);">„Åæ„Å†„É≠„Éº„É´„ÅåËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>';
                    return;
                }
                listEl.innerHTML = Object.entries(roles).map(([id, data]) => `
                    <div class="role-item" data-id="${id}">
                        <div class="role-info">
                            <span class="role-name">${data.name}</span>
                            <span class="role-genre-tag">${data.genre}</span>
                        </div>
                        <button class="btn btn-danger btn-small remove-role-btn">&times;</button>
                    </div>`).join('');
            };
            renderModalRoleList();

            modal.querySelector('#add-role-btn').onclick = () => {
                const roleId = selectEl.tomselect.getValue();
                const genre = modal.querySelector('#add-role-genre').value.trim();
                const role = guildInfo.roles.find(r => r.id === roleId);

                if (!roleId || !genre || !role) {
                    return showMessage('„É≠„Éº„É´„Å®„Ç∏„É£„É≥„É´„ÇíÈÅ∏Êäû„ÉªÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                }

                localBoard.roles = localBoard.roles || {};
                if (localBoard.roles[roleId]) {
                    return showMessage('„Åì„ÅÆ„É≠„Éº„É´„ÅØÊó¢„Å´ËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ', 'warning');
                }

                localBoard.roles[roleId] = { name: role.name, genre, emoji: null };

                localBoard.genres = localBoard.genres || {};
                if (!localBoard.genres[genre]) localBoard.genres[genre] = [];
                if (!localBoard.genres[genre].includes(roleId)) localBoard.genres[genre].push(roleId);

                renderModalRoleList();
                modal.querySelector('#add-role-genre').value = '';
                selectEl.tomselect.clear();
            };

            modal.querySelector('#modal-role-list').onclick = e => {
                if (e.target.classList.contains('remove-role-btn')) {
                    const roleItem = e.target.closest('.role-item');
                    const roleId = roleItem.dataset.id;
                    const roleGenre = localBoard.roles[roleId].genre;

                    delete localBoard.roles[roleId];

                    if (localBoard.genres?.[roleGenre]) {
                        localBoard.genres[roleGenre] = localBoard.genres[roleGenre].filter(id => id !== roleId);
                        if (localBoard.genres[roleGenre].length === 0) {
                            delete localBoard.genres[roleGenre];
                        }
                    }
                    renderModalRoleList();
                }
            };

            document.getElementById('save-board-changes').onclick = async () => {
                const title = modal.querySelector('#edit-title').value.trim();
                if (!title) return showMessage('„Çø„Ç§„Éà„É´„ÅØÂøÖÈ†à„Åß„Åô„ÄÇ', 'error');

                try {
                    await api.put(`/api/roleboards/${boardId}`, {
                        title,
                        description: modal.querySelector('#edit-desc').value.trim(),
                        color: parseInt(colorText.value.replace('#', ''), 16),
                        roles: localBoard.roles,
                        genres: localBoard.genres
                    });
                    showMessage('„É≠„Éº„É´„Éú„Éº„Éâ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇ');
                    closeModal();
                    await renderRoleboardList();
                } catch (error) {
                    showMessage(`Êõ¥Êñ∞„Ç®„É©„Éº: ${error.message}`, 'error');
                }
            };
        } catch (error) {
            showMessage(`„Ç®„É©„Éº: ${error.message}`, 'error');
        }
    };

    const confirmDeleteRoleboard = (boardId) => {
        createModal('ÂâäÈô§„ÅÆÁ¢∫Ë™ç', `
            <p>Êú¨ÂΩì„Å´„Åì„ÅÆ„É≠„Éº„É´„Éú„Éº„Éâ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ</p>`,
            [
                { id: 'cancel-delete', text: '„Ç≠„É£„É≥„Çª„É´', class: 'btn-secondary' },
                { id: 'confirm-delete', text: 'ÂâäÈô§', class: 'btn-danger' }
            ]
        );
        document.getElementById('cancel-delete').onclick = closeModal;
        document.getElementById('confirm-delete').onclick = async () => {
            try {
                await api.delete(`/api/roleboards/${boardId}`);
                showMessage('„É≠„Éº„É´„Éú„Éº„Éâ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ');
                closeModal();
                await renderRoleboardList();
            } catch (error) {
                showMessage(`ÂâäÈô§„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        };
    };

    // --- Form Handling ---
    const handleFormSubmit = async (e, directSettings = null) => {
        e.preventDefault();
        const form = e.target;
        const btn = form.querySelector('button[type="submit"]');
        const btnText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '‰øùÂ≠ò‰∏≠...';

        const page = new URL(location.href).hash.substring(1);
        let settings, collection;

        try {
            if (directSettings) {
                collection = 'guild_settings';
                settings = directSettings;
            } else {
                switch (page) {
                    case 'welcome':
                        collection = 'guilds';
                        settings = {
                            welcomeChannelId: form.querySelector('#welcomeChannelId').value || null,
                            goodbyeChannelId: form.querySelector('#goodbyeChannelId').value || null,
                            rulesChannelId: form.querySelector('#rulesChannelId').value || null,
                            welcomeRoleId: form.querySelector('#welcomeRoleId').value || null,
                            mentionOnWelcome: form.querySelector('#mentionOnWelcome').checked,
                            sendGoodbyeDM: form.querySelector('#sendGoodbyeDM').checked
                        };
                        break;
                    case 'welcome-message':
                        await api.post(`/api/settings/welcome-message`, {
                            enabled: form.querySelector('#welcome-enabled').checked,
                            type: form.querySelector('#welcome-type').value,
                            title: form.querySelector('#welcome-title').value,
                            description: form.querySelector('#welcome-description').value,
                            imageUrl: form.querySelector('#welcome-imageUrl').value,
                            color: form.querySelector('#welcome-color-text').value,
                        });
                        showMessage('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
                        resetDirtyState();
                        btn.disabled = false;
                        btn.textContent = btnText;
                        return;
                    case 'announcements':
                        collection = 'guild_settings';
                        settings = {
                            announcementChannelId: form.querySelector('#announcementChannelId').value || null
                        };
                        break;
                    case 'autorole':
                        collection = 'guild_settings';
                        settings = {
                            botAutoroleId: form.querySelector('#botAutoroleId').value || null
                        };
                        break;
                    case 'automod':
                        collection = 'guild_settings';
                        settings = {
                            automod: {
                                ngWords: form.querySelector('#ngWords').value.split(',').map(w => w.trim()).filter(Boolean),
                                blockInvites: form.querySelector('#blockInvites').checked
                            }
                        };
                        break;
                    case 'logging':
                        collection = 'guild_settings';
                        settings = {
                            auditLogChannel: form.querySelector('#auditLogChannel').value || null
                        };
                        break;
                    case 'ai':
                        collection = 'guild_settings';
                        settings = {
                            ai: {
                                mentionReplyEnabled: form.querySelector('#mentionReplyEnabled').checked,
                                aiPersonalityPrompt: form.querySelector('#aiPersonalityPrompt').value
                            }
                        };
                        break;
                    default:
                        btn.disabled = false;
                        btn.textContent = btnText;
                        return;
                }
            }
            await api.post(`/api/settings/${collection}`, settings);
            showMessage('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
            resetDirtyState();
        } catch (error) {
            showMessage(`‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = btnText;
        }
    };

    // --- Navigation ---
    const navigate = async (event) => {
        const proceed = async () => {
            resetDirtyState();
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('is-open');
            }

            const page = window.location.hash.substring(1) || 'dashboard';
            navItems.forEach(item => item.classList.toggle('active', item.dataset.page === page));
            pageContent.innerHTML = '<div class="loader-ring" style="margin: 40px auto;"></div>';

            if (renderers[page]) {
                try {
                    await renderers[page]();
                } catch (error) {
                    pageContent.innerHTML = `<p class="message error show" style="background-color: var(--error-color); color: white; padding: 15px; border-radius: var(--border-radius); text-align: center;">„Éö„Éº„Ç∏„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}</p>`;
                }
            } else {
                pageContent.innerHTML = `<p class="message error show" style="background-color: var(--error-color); color: white; padding: 15px; border-radius: var(--border-radius); text-align: center;">„Éö„Éº„Ç∏„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ</p>`;
            }

            feather.replace();
        };
        
        if (isDirty) {
             if (event && event.type === 'hashchange') {
                event.preventDefault();
                const oldHash = event.oldURL.split('#')[1] || 'dashboard';
                history.pushState(null, null, `#${oldHash}`);
            }

            createModal('Êú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åô',
                '<p>„Éö„Éº„Ç∏„ÇíÁßªÂãï„Åô„Çã„Å®„ÄÅ‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ§âÊõ¥„ÅØÂ§±„Çè„Çå„Åæ„Åô„ÄÇÊú¨ÂΩì„Å´ÁßªÂãï„Åó„Åæ„Åô„ÅãÔºü</p>',
                [
                    { id: 'cancel-nav', text: '„Ç≠„É£„É≥„Çª„É´', class: 'btn-secondary' },
                    { id: 'confirm-nav', text: 'ÁßªÂãï„Åô„Çã', class: 'btn-danger' }
                ]
            );
            document.getElementById('cancel-nav').onclick = closeModal;
            document.getElementById('confirm-nav').onclick = () => {
                closeModal();
                if (event) {
                    const newHash = new URL(event.newURL).hash;
                    window.location.hash = newHash;
                }
                proceed();
            };
        } else {
            proceed();
        }
    };

    // --- Member Actions ---
    const addMemberActionListeners = () => {
        document.querySelectorAll('.manage-roles-btn').forEach(btn => btn.onclick = handleManageRoles);
        document.querySelectorAll('.kick-btn').forEach(btn => btn.onclick = handleKickMember);
        document.querySelectorAll('.ban-btn').forEach(btn => btn.onclick = handleBanMember);
    };

    const handleManageRoles = async (e) => {
        const memberId = e.target.closest('tr').dataset.memberId;
        // API„Åã„ÇâÂÜçÂèñÂæó„Åô„Çã‰ª£„Çè„Çä„Å´„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂà©Áî®„Åô„ÇãÔºà„Åü„Å†„Åó„ÄÅÂ§ßË¶èÊ®°„Å™Â§âÊõ¥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂÜçÂèñÂæó„ÅåÊúõ„Åæ„Åó„ÅÑÔºâ
        // For simplicity, we assume the initial fetch is recent enough.
        // const members = await api.get('/api/members');
        // const member = members.find(m => m.id === memberId);
        const memberRow = document.querySelector(`tr[data-member-id="${memberId}"]`);
        const memberName = memberRow.querySelector('.display-name').textContent;
        const currentRoles = Array.from(memberRow.querySelectorAll('.role-tag')).map(tag => {
            const role = guildInfo.roles.find(r => r.name === tag.textContent);
            return role ? role.id : null;
        }).filter(Boolean);


        const modal = createModal(`„É≠„Éº„É´ÁÆ°ÁêÜ: ${memberName}`, `
            <div class="form-group">
                <label>„É≠„Éº„É´„ÇíÁ∑®ÈõÜ</label>
                <select id="roles-select" multiple placeholder="„É≠„Éº„É´„ÇíÈÅ∏Êäû...">
                    ${guildInfo.roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                </select>
            </div>`,
            [{ id: 'save-roles', text: '‰øùÂ≠ò', class: 'btn'}]
        );
        initializeTomSelect('#roles-select', {
            items: currentRoles
        });
        
        document.getElementById('save-roles').onclick = async () => {
            const selectedRoles = document.getElementById('roles-select').tomselect.getValue();
            try {
                await api.put(`/api/members/${memberId}/roles`, { roles: selectedRoles });
                showMessage('„É≠„Éº„É´„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇ');
                closeModal();
                // „ÉÜ„Éº„Éñ„É´ÂÖ®‰Ωì„Åß„ÅØ„Å™„Åè„ÄÅË©≤ÂΩìË°å„Å†„ÅëÊõ¥Êñ∞„Åô„Çã„Åì„Å®„ÇÇÂèØËÉΩ„Å†„Åå„ÄÅÂÜçÊèèÁîª„ÅåÁ¢∫ÂÆü
                document.querySelector(`.nav-item[data-page="members"]`).click();
            } catch(error) {
                showMessage('„É≠„Éº„É´„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            }
        };
    };

    const handleKickMember = (e) => {
        const memberId = e.target.closest('tr').dataset.memberId;
        createModal('„É°„É≥„Éê„Éº„Çí„Ç≠„ÉÉ„ÇØ', `
            <p>Êú¨ÂΩì„Å´„Åì„ÅÆ„É°„É≥„Éê„Éº„Çí„Ç≠„ÉÉ„ÇØ„Åó„Åæ„Åô„ÅãÔºü</p>
            <div class="form-group" style="margin-top:15px;"><label>ÁêÜÁî± (‰ªªÊÑè)</label><input type="text" id="kick-reason"></div>`,
            [{ id: 'confirm-kick', text: '„Ç≠„ÉÉ„ÇØ', class: 'btn-danger'}]
        );
        document.getElementById('confirm-kick').onclick = async () => {
            const reason = document.getElementById('kick-reason').value;
            try {
                await api.post(`/api/members/${memberId}/kick`, { reason });
                showMessage('„É°„É≥„Éê„Éº„Çí„Ç≠„ÉÉ„ÇØ„Åó„Åæ„Åó„Åü„ÄÇ');
                closeModal();
                document.querySelector(`.nav-item[data-page="members"]`).click();
            } catch(error) {
                showMessage('„Ç≠„ÉÉ„ÇØ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            }
        };
    };

    const handleBanMember = (e) => {
        const memberId = e.target.closest('tr').dataset.memberId;
        createModal('„É°„É≥„Éê„Éº„ÇíBAN', `
            <p>Êú¨ÂΩì„Å´„Åì„ÅÆ„É°„É≥„Éê„Éº„Çí„Çµ„Éº„Éê„Éº„Åã„ÇâBAN„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ</p>
            <div class="form-group" style="margin-top:15px;"><label>ÁêÜÁî± (‰ªªÊÑè)</label><input type="text" id="ban-reason"></div>`,
            [{ id: 'confirm-ban', text: 'BAN', class: 'btn-danger'}]
        );
        document.getElementById('confirm-ban').onclick = async () => {
            const reason = document.getElementById('ban-reason').value;
            try {
                await api.post(`/api/members/${memberId}/ban`, { reason });
                showMessage('„É°„É≥„Éê„Éº„ÇíBAN„Åó„Åæ„Åó„Åü„ÄÇ');
                closeModal();
                document.querySelector(`.nav-item[data-page="members"]`).click();
            } catch(error) {
                showMessage('BAN„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            }
        };
    };


    // --- Initialization ---
    const init = async () => {
        try {
            guildInfo = await api.get('/api/guild-info');
            document.getElementById('server-icon').src = guildInfo.icon || 'https://cdn.discordapp.com/embed/avatars/0.png';
            document.getElementById('server-name').textContent = guildInfo.name;

            loader.style.display = 'none';
            dashboardWrapper.style.display = 'flex';
            
            window.addEventListener('hashchange', navigate, false);
            await navigate();

            logoutBtn.addEventListener('click', () => {
                createModal('„É≠„Ç∞„Ç¢„Ç¶„Éà„ÅÆÁ¢∫Ë™ç',
                    '<p>Êú¨ÂΩì„Å´„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü</p>',
                    [
                        { id: 'cancel-logout', text: '„Ç≠„É£„É≥„Çª„É´', class: 'btn-secondary' },
                        { id: 'confirm-logout', text: '„É≠„Ç∞„Ç¢„Ç¶„Éà', class: 'btn-danger' }
                    ]
                );
                document.getElementById('cancel-logout').onclick = closeModal;
                document.getElementById('confirm-logout').onclick = async () => {
                    try {
                        isDirty = false;
                        await api.post('/api/logout');
                        window.location.href = '/login';
                    } catch (err) {
                        showMessage('„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                    }
                };
            });

            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('is-open');
            });

            window.addEventListener('beforeunload', (e) => {
                if (isDirty) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });

        } catch (error) {
            loader.innerHTML = `<p class="message error" style="background-color: var(--error-color); color: white; padding: 15px; border-radius: var(--border-radius); text-align: center;">ÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂÜç„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p><a href="/login" class="btn" style="margin-top:20px;">„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å∏</a>`;
        }
    };

    init();
});